<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coffee Shop POS â€” Revamped</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        :root {
            color-scheme: light dark;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';
            /* Coffee art background */
            background: radial-gradient(1200px 600px at 10% 10%, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0) 50%),
                radial-gradient(1200px 600px at 90% 0%, rgba(255, 237, 213, 0.7), rgba(255, 237, 213, 0) 50%),
                linear-gradient(180deg, #fff7ed 0%, #f5e6d3 100%);
        }

        /* Glass & motion helpers */
        .glass {
            backdrop-filter: blur(10px);
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.6));
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .card-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .section {
            transition: opacity .3s ease, transform .3s ease;
            transform: translateY(0);
        }

        .section.hidden {
            opacity: 0;
            transform: translateY(20px);
            display: none;
        }

        .btn {
            transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 18px rgba(0, 0, 0, .12);
        }

        .btn:active {
            transform: translateY(0);
            filter: brightness(.98);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2c1b0f;
            color: #fff;
            padding: 12px 16px;
            border-radius: 12px;
            opacity: 0;
            transform: translateY(10px);
            transition: all .3s ease;
            z-index: 60;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Mobile tweaks */
        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <nav id="sidebar"
            class="hidden md:flex md:flex-col md:w-72 p-5 bg-[#23160e] text-white sticky top-0 h-screen overflow-y-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span
                        class="inline-flex h-10 w-10 rounded-xl bg-amber-500 items-center justify-center text-white font-bold">â˜•</span>
                    <h1 class="text-2xl font-bold tracking-tight">Espresso POS</h1>
                </div>
                <button id="closeSidebar" class="md:hidden text-white/80 hover:text-white" aria-label="Close sidebar">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="mt-6 grid gap-2">
                <button onclick="showSection('pos'); setActive(this)"
                    class="btn px-4 py-3 rounded-xl bg-amber-600 hover:bg-amber-500 text-white flex items-center justify-between">
                    <span class="flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 3h18v6H3zM16 13H8a4 4 0 00-4 4v4h16v-4a4 4 4 0 00-4-4z" />
                        </svg> POS</span>
                    <span class="text-xs bg-black/30 px-2 py-0.5 rounded">âŒ˜1</span>
                </button>
                <button onclick="showSection('inventory'); setActive(this)"
                    class="btn px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white flex items-center justify-between">
                    <span class="flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 13V7a2 2 0 00-2-2h-3l-2-2H9L7 5H4a2 2 0 00-2 2v6m18 0a2 2 0 01-2 2H6a2 2 0 01-2-2m16 0v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6" />
                        </svg> Inventory</span>
                    <span class="text-xs bg-black/30 px-2 py-0.5 rounded">âŒ˜2</span>
                </button>
                <button onclick="showSection('history'); setActive(this)"
                    class="btn px-4 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white flex items-center justify-between">
                    <span class="flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg> History</span>
                    <span class="text-xs bg-black/30 px-2 py-0.5 rounded">âŒ˜3</span>
                </button>
                <button onclick="endDay()"
                    class="btn px-4 py-3 rounded-xl bg-rose-600 hover:bg-rose-500 text-white flex items-center justify-between">
                    <span class="flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1" />
                        </svg> End Day</span>
                </button>
            </div>

            <div class="mt-8 grid grid-cols-1 gap-3">
                <div class="glass card-shadow rounded-2xl p-4">
                    <div class="text-sm text-white/70">Today's Sales</div>
                    <div class="text-2xl font-bold">$<span id="dailySalesSidebar">0.00</span></div>
                </div>
                <div class="glass card-shadow rounded-2xl p-4">
                    <div class="text-sm text-white/70">Low Stock Alerts</div>
                    <div class="text-lg" id="lowStockBadge">â€”</div>
                </div>
            </div>
        </nav>

        <!-- Main -->
        <main class="flex-1 p-4 md:p-8">
            <!-- Top bar -->
            <header class="glass card-shadow sticky top-0 z-40 p-4 md:p-5 rounded-2xl mb-6">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <button id="openSidebar"
                            class="md:hidden inline-flex items-center justify-center rounded-xl bg-[#23160e] text-white p-2"
                            aria-label="Open sidebar">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16m-7 6h7" />
                            </svg>
                        </button>
                        <h1 class="text-xl md:text-2xl font-bold text-[#2c1b0f]">Espresso POS</h1>
                    </div>
                    <div class="relative w-full max-w-lg hidden md:block">
                        <input id="searchInput" type="text" placeholder="Search itemsâ€¦"
                            class="w-full pl-10 pr-4 py-2 rounded-xl border border-amber-200 focus:ring-2 focus:ring-amber-400 outline-none"
                            oninput="filterItems(this.value)" />
                        <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-amber-700" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z" />
                        </svg>
                    </div>
                </div>
            </header>

            <!-- POS Section -->
            <section id="pos" class="section glass card-shadow rounded-2xl p-4 md:p-6" aria-label="Point of Sale">
                <div class="flex items-start flex-col md:flex-row gap-6">
                    <!-- Items -->
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-xl font-semibold text-[#2c1b0f]">Items</h2>
                            <div class="md:hidden w-full max-w-xs relative">
                                <input type="text" placeholder="Search itemsâ€¦"
                                    class="w-full pl-10 pr-4 py-2 rounded-xl border border-amber-200 focus:ring-2 focus:ring-amber-400 outline-none"
                                    oninput="filterItems(this.value)" />
                                <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-amber-700" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z" />
                                </svg>
                            </div>
                        </div>
                        <div id="itemsList" class="grid items-grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                        </div>
                    </div>

                    <!-- Cart -->
                    <div class="w-full md:w-[380px] shrink-0">
                        <div class="rounded-2xl p-4 md:p-5 bg-white/90 border border-amber-100 card-shadow">
                            <h3 class="text-lg font-semibold text-[#2c1b0f] mb-3">Cart</h3>
                            <ul id="cart" class="divide-y"></ul>
                            <div class="flex items-center justify-between mt-4 text-[#2c1b0f]">
                                <span class="font-medium">Total</span>
                                <span class="text-2xl font-bold">$<span id="cartTotal">0.00</span></span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-4">
                                <button onclick="charge()"
                                    class="btn rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white py-3 font-semibold">Charge</button>
                                <button onclick="clearCart()"
                                    class="btn rounded-xl bg-rose-600 hover:bg-rose-500 text-white py-3">Clear</button>
                            </div>
                        </div>
                        <p class="mt-3 text-sm text-[#2c1b0f]/80">Today's Sales: $<span id="dailySales">0.00</span></p>
                    </div>
                </div>
            </section>

            <!-- Inventory Section -->
            <section id="inventory" class="section hidden glass card-shadow rounded-2xl p-4 md:p-6"
                aria-label="Inventory Stock">
                <h2 class="text-xl font-semibold text-[#2c1b0f] mb-4">Inventory â€” Stock Only</h2>
                <p class="text-sm text-[#2c1b0f]/70 mb-3">Catalog items now come from <code>items.json</code>. This page
                    is only for adjusting <strong>stock quantities</strong>.</p>
                <div class="table-responsive">
                    <table class="w-full text-left rounded-xl overflow-hidden border">
                        <thead class="bg-amber-50">
                            <tr class="border-b">
                                <!-- <th class="py-3 px-3 text-black">SKU</th> -->
                                <th class="py-3 px-3 text-black">Name</th>
                                <th class="py-3 px-3 text-black">Stock Qty</th>
                                <th class="py-3 px-3 text-black">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable" class="divide-y text-black"></tbody>
                    </table>
                </div>
            </section>

            <!-- History Section -->
            <section id="history" class="section hidden glass card-shadow rounded-2xl p-4 md:p-6"
                aria-label="Sales History">
                <h2 class="text-xl font-semibold text-[#2c1b0f] mb-4">Sales History</h2>
                <div class="table-responsive">
                    <table class="w-full text-left rounded-xl overflow-hidden border">
                        <thead class="bg-indigo-50">
                            <tr class="border-b">
                                <th class="py-3 px-3 text-black">Date</th>
                                <th class="py-3 px-3 text-black">Total Sales</th>
                                <th class="py-3 px-3 text-black">Items Sold</th>
                                <th class="py-3 px-3 text-black">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable" class="divide-y text-black"></tbody>
                    </table>
                </div>
                <button onclick="exportHistory()"
                    class="btn bg-blue-600 hover:bg-blue-500 text-white rounded-xl px-4 py-2 mt-4">Export All</button>
            </section>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" role="alert"></div>

    <script>
        // =========================
        // Catalog (items.json) + Stock (stock.json)
        // =========================
        let catalog = [] // [{ sku, name, price, requiresCup, requiresStraw }]
        let stock = {}   // { [sku]: qty }

        let cart = []
        let dailySales = parseFloat(localStorage.getItem('dailySales')) || 0
        let history = JSON.parse(localStorage.getItem('history')) || []
        let orders = JSON.parse(localStorage.getItem('orders')) || []
        let currentDate = new Date().toISOString().split('T')[0]

        const storedDate = localStorage.getItem('currentDate')
        if (storedDate !== currentDate) {
            dailySales = 0
            localStorage.setItem('dailySales', dailySales)
            localStorage.setItem('currentDate', currentDate)
        }

        async function loadData() {
            // Load catalog from items.json
            try {
                const r = await fetch('items.json', { cache: 'no-store' })
                catalog = await r.json()
            } catch (e) {
                // Fallback demo catalog
                catalog = [
                    { sku: 'coffee', name: 'Coffee', price: 5.00, requiresCup: true, requiresStraw: true },
                    { sku: 'tea', name: 'Tea', price: 3.50, requiresCup: true, requiresStraw: true },
                    { sku: 'pastry', name: 'Pastry', price: 2.50, requiresCup: false, requiresStraw: false },
                ]
            }
            // Load stock from stock.json, but let localStorage override
            try {
                const r2 = await fetch('stock.json', { cache: 'no-store' })
                stock = await r2.json()
            } catch (e) {
                stock = { coffee: 100, tea: 50, pastry: 30, cup: 200, straw: 200 }
            }
            const lsStock = localStorage.getItem('stock')
            if (lsStock) stock = JSON.parse(lsStock)

            // Initial renders
            renderItems()
            renderCart()
            renderInventory()
            renderHistory()
            updateLowStockBadge()
            const ds = document.getElementById('dailySales')
            if (ds) ds.textContent = dailySales.toFixed(2)
            const dss = document.getElementById('dailySalesSidebar')
            if (dss) dss.textContent = dailySales.toFixed(2)
            showSection('pos')

            // Run self-tests after initial render
            runSelfTests()
        }
        window.addEventListener('DOMContentLoaded', loadData)

        // ---------- Helpers ----------
        function saveData() {
            try {
                localStorage.setItem('stock', JSON.stringify(stock))
                localStorage.setItem('dailySales', dailySales)
                localStorage.setItem('history', JSON.stringify(history))
                localStorage.setItem('orders', JSON.stringify(orders))
            } catch (e) { showToast('Storage error. Check browser settings.') }
        }
        function showToast(message) {
            const toast = document.getElementById('toast')
            toast.textContent = message
            toast.classList.add('show')
            setTimeout(() => toast.classList.remove('show'), 2200)
        }
        function setActive(btn) {
            document.querySelectorAll('#sidebar .btn').forEach(b => b.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-[#23160e]'))
            btn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-[#23160e]')
        }
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'))
            document.getElementById(section).classList.remove('hidden')
            document.getElementById('sidebar').classList.add('hidden')
            showToast(section.charAt(0).toUpperCase() + section.slice(1) + ' opened')
        }

        // ---------- Items (from catalog) ----------
        function getEmoji(name) {
            const n = name.toLowerCase()
            if (n.includes('coffee')) return 'â˜•'
            if (n.includes('tea')) return 'ðŸ«–'
            if (n.includes('pastry')) return 'ðŸ¥'
            return 'ðŸ½ï¸'
        }
        function filterItems(query) {
            const q = (query || '').toLowerCase()
            const list = catalog.filter(i => i.name.toLowerCase().includes(q))
            renderItems(list)
        }
        function renderItems(list = catalog) {
            const el = document.getElementById('itemsList')
            el.innerHTML = ''
            list.forEach(item => {
                const btn = document.createElement('button')
                btn.className = 'group relative text-left rounded-2xl p-4 bg-white/90 border hover:border-amber-300 hover:bg-amber-50 transition btn card-shadow'
                btn.setAttribute('aria-label', `Add ${item.name} to cart`)
                btn.onclick = () => addToCart(item)
                btn.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-amber-200 to-amber-100 flex items-center justify-center text-2xl">${getEmoji(item.name)}</div>
            <div class="flex-1">
              <div class="font-semibold text-[#2c1b0f]">${item.name}</div>
              <div class="text-sm text-[#2c1b0f]/70">$${item.price.toFixed(2)}</div>
            </div>
          </div>`
                el.appendChild(btn)
            })
        }

        // ---------- Cart ----------
        function addToCart(item) {
            // POS is order-only: no stock linkage or cup/straw checks
            const existing = cart.find(c => c.sku === item.sku)
            if (existing) existing.qty++
            else cart.push({ sku: item.sku, name: item.name, qty: 1, price: item.price })
            renderCart()
            showToast(`${item.name} added to cart`)
        }
        function renderCart() {
            const list = document.getElementById('cart')
            list.innerHTML = ''
            let total = 0
            cart.forEach((item, index) => {
                const li = document.createElement('li')
                li.className = 'py-3 flex items-center justify-between gap-3'
                li.innerHTML = `
          <div class="min-w-0">
            <div class="font-medium text-[#2c1b0f] truncate">${item.name}</div>
            <div class="text-sm text-[#2c1b0f]/70">$${item.price.toFixed(2)} each</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="h-8 w-8 rounded-lg bg-amber-100 hover:bg-amber-200" aria-label="Decrease" onclick="updateCartQty(${index}, -1)">âˆ’</button>
            <span class="w-8 text-center">${item.qty}</span>
            <button class="h-8 w-8 rounded-lg bg-amber-100 hover:bg-amber-200" aria-label="Increase" onclick="updateCartQty(${index}, 1)">+</button>
          </div>
          <div class="w-20 text-right font-semibold">$${(item.qty * item.price).toFixed(2)}</div>
          <button class="text-rose-600 hover:text-rose-700" aria-label="Remove" onclick="removeCartIndex(${index})">Remove</button>`
                list.appendChild(li)
                total += item.qty * item.price
            })
            document.getElementById('cartTotal').textContent = total.toFixed(2)
        }
        function updateCartQty(index, delta) {
            // POS is order-only: no stock validation
            const item = cart[index]; if (!item) return
            item.qty += delta
            if (item.qty <= 0) cart.splice(index, 1)
            renderCart()
        }
        function removeCartIndex(index) { cart.splice(index, 1); renderCart(); showToast('Removed from cart') }

        function charge() {
            const total = parseFloat(document.getElementById('cartTotal').textContent)
            if (total <= 0) { showToast('Cart is empty!'); return }

            // Order-only: do not validate or decrement stock
            const orderItems = cart.map(i => ({ sku: i.sku, name: i.name, qty: i.qty, price: i.price, total: i.qty * i.price }))

            dailySales += total
            orders.push({ date: currentDate, items: orderItems, total })

            const ds = document.getElementById('dailySales'); if (ds) ds.textContent = dailySales.toFixed(2)
            const dss = document.getElementById('dailySalesSidebar'); if (dss) dss.textContent = dailySales.toFixed(2)

            saveData()
            renderHistory()
            clearCart(false)
            showToast('Order recorded âœ…')
        }
        function clearCart(show = true) { cart = []; renderCart(); if (show) showToast('Cart cleared') }

        // ---------- Inventory (stock only) ----------
        function renderInventory() {
            const table = document.getElementById('inventoryTable')
            if (!table) return
            table.innerHTML = ''

            // Build a lookup from catalog for names
            const nameBySku = Object.fromEntries(catalog.map(i => [i.sku, i.name]))

            // Render all stock entries (including cup/straw)
            Object.keys(stock).sort().forEach(sku => {
                const row = document.createElement('tr')
                const qty = stock[sku] || 0
                const name = nameBySku[sku] || sku.charAt(0).toUpperCase() + sku.slice(1)
                row.className = 'hover:bg-amber-50/50'
                row.innerHTML = `
          <td class="py-3 px-3 font-mono text-sm">${sku}</td>
          <td class="py-3 px-3">${name}</td>
          <td class="py-3 px-3 ${qty < 10 ? 'text-rose-600 font-medium' : ''}">${qty}</td>
          <td class="py-3 px-3 space-x-2">
            <button class="text-blue-600 hover:text-blue-800" onclick="editStock('${sku}')">Adjust</button>
            <button class="text-rose-600 hover:text-rose-800" onclick="setStockZero('${sku}')">Set 0</button>
          </td>`
                table.appendChild(row)
            })
            updateLowStockBadge()
        }
        function editStock(sku) {
            const current = stock[sku] || 0
            const next = prompt(`New stock for ${sku}:`, current)
            if (next === null) return
            const n = parseInt(next)
            if (Number.isNaN(n) || n < 0) { showToast('Invalid quantity'); return }
            stock[sku] = n
            saveData(); renderInventory(); renderItems(); showToast('Stock updated')
        }
        function setStockZero(sku) { stock[sku] = 0; saveData(); renderInventory(); renderItems(); showToast(`${sku} set to 0`) }

        function updateLowStockBadge() {
            const nameBySku = Object.fromEntries(catalog.map(i => [i.sku, i.name]))
            const low = Object.entries(stock).filter(([sku, q]) => (q || 0) < 10).map(([sku, q]) => `${nameBySku[sku] || sku}(${q})`)
            const badge = document.getElementById('lowStockBadge')
            if (!badge) return
            badge.textContent = low.length ? low.join(', ') : 'All good'
        }

        // ---------- History & Export ----------
        function renderHistory() {
            const table = document.getElementById('historyTable')
            if (!table) return
            table.innerHTML = ''
            const dailyTotals = {}
            orders.forEach(order => {
                if (!dailyTotals[order.date]) dailyTotals[order.date] = { total: 0, items: [] }
                dailyTotals[order.date].total += order.total
                order.items.forEach(item => {
                    const existing = dailyTotals[order.date].items.find(i => i.sku === item.sku)
                    if (existing) { existing.qty += item.qty; existing.total += item.total }
                    else { dailyTotals[order.date].items.push({ ...item }) }
                })
            })
            Object.keys(dailyTotals).forEach(date => {
                const entry = dailyTotals[date]
                const itemsList = entry.items.map(item => `${item.name} x${item.qty}`).join(', ')
                const row = document.createElement('tr')
                row.className = 'hover:bg-indigo-50/40'
                row.innerHTML = `
          <td class="py-3 px-3">${date}</td>
          <td class="py-3 px-3">$${entry.total.toFixed(2)}</td>
          <td class="py-3 px-3">${itemsList}</td>
          <td class="py-3 px-3"><button onclick="exportDay('${date}')" class="text-blue-600 hover:text-blue-800">Export Day</button></td>`
                table.appendChild(row)
            })
        }

        function endDay() {
            if (dailySales > 0 && confirm('End the day and save to history?')) {
                history.push({ date: currentDate, total: dailySales })
                dailySales = 0
                currentDate = new Date().toISOString().split('T')[0]
                localStorage.setItem('currentDate', currentDate)
                localStorage.setItem('dailySales', dailySales)
                saveData()
                const ds = document.getElementById('dailySales'); if (ds) ds.textContent = '0.00'
                const dss = document.getElementById('dailySalesSidebar'); if (dss) dss.textContent = '0.00'
                renderHistory()
                showToast('Day ended and saved to history')
            } else if (dailySales === 0) { showToast('No sales to save for today!') }
        }

        function exportDay(date) {
            const dailyOrders = orders.filter(order => order.date === date)
            const exportData = dailyOrders.flatMap(order =>
                order.items.map(item => ({ Date: order.date, SKU: item.sku, Item: item.name, Quantity: item.qty, Price: item.price, Total: item.total }))
            )
            const ws = XLSX.utils.json_to_sheet(exportData)
            const wb = XLSX.utils.book_new()
            XLSX.utils.book_append_sheet(wb, ws, 'Day Sales')
            XLSX.writeFile(wb, `sales_${date}.xlsx`)
            showToast(`Exported sales for ${date}`)
        }

        function exportHistory() {
            const exportData = orders.flatMap(order =>
                order.items.map(item => ({ Date: order.date, SKU: item.sku, Item: item.name, Quantity: item.qty, Price: item.price, Total: item.total }))
            )
            const ws = XLSX.utils.json_to_sheet(exportData)
            const wb = XLSX.utils.book_new()
            XLSX.utils.book_append_sheet(wb, ws, 'History')
            XLSX.writeFile(wb, 'sales_history.xlsx')
            showToast('Exported all sales history')
        }

        // ---------- Self tests (non-intrusive) ----------
        function runSelfTests() {
            try {
                const log = (name, ok) => console[ok ? 'log' : 'error'](`[TEST] ${ok ? 'PASS' : 'FAIL'}: ${name}`)

                // backup globals & toast
                const _backup = {
                    cart: JSON.parse(JSON.stringify(cart)),
                    dailySales,
                    orders: JSON.parse(JSON.stringify(orders)),
                    showToast,
                }
                // silence toasts during tests
                window.showToast = () => { }

                // Reset state for tests
                cart = []
                dailySales = 0
                orders = []

                const testItem = { sku: 'test', name: 'Test Item', price: 1.25 }

                // addToCart
                addToCart(testItem)
                log('addToCart adds one item', cart.length === 1 && cart[0].qty === 1)

                // updateCartQty increase
                updateCartQty(0, 1)
                log('updateCartQty +1 increments qty', cart[0].qty === 2)

                // charge
                charge()
                log('charge clears cart', cart.length === 0)
                log('charge updates dailySales', Math.abs(dailySales - (2 * 1.25)) < 1e-6)
                log('charge creates one order', orders.length === 1)

                // restore
                cart = _backup.cart
                dailySales = _backup.dailySales
                orders = _backup.orders
                window.showToast = _backup.showToast
                renderCart()
                const ds = document.getElementById('dailySales'); if (ds) ds.textContent = dailySales.toFixed(2)
                const dss = document.getElementById('dailySalesSidebar'); if (dss) dss.textContent = dailySales.toFixed(2)
            } catch (err) {
                console.error('[TEST] Exception during self-tests:', err)
            }
        }

        // Sidebar toggle
        document.getElementById('openSidebar').onclick = () => document.getElementById('sidebar').classList.remove('hidden')
        const closeBtn = document.getElementById('closeSidebar')
        if (closeBtn) closeBtn.onclick = () => document.getElementById('sidebar').classList.add('hidden')
    </script>
</body>

</html>